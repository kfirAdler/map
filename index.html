<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מפת אטרקציות - מדריד</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #1e1e1e;
            color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            padding: 10px;
            font-family: sans-serif;
            font-size: 14px;
            display: none;
            z-index: 999;
        }
        #toggleButton {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            padding: 8px 12px;
            background: #333;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
        }
        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-left: 6px;
            border-radius: 50%;
        }
        a { color: #80c9ff; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<button id="toggleButton" onclick="toggleLegend()">הצג / הסתר מקרא</button>

<div id="legend">
    <div><span class="legend-color" style="background: #a6cee3;"></span> אטרקציות כלליות</div>
    <div><span class="legend-color" style="background: #fdbf6f;"></span> מסעדות ושווקים</div>
    <div><span class="legend-color" style="background: #cab2d6;"></span> מוזיאונים</div>
    <div><span class="legend-color" style="background: #b2df8a;"></span> פארקים</div>
    <div><span class="legend-color" style="background: #fccde5;"></span> אתרי תרבות</div>
</div>

<div id="map"></div>

<script>
    const pastelColors = {
        general: '#a6cee3',
        markets: '#fdbf6f',
        museums: '#cab2d6',
        parks: '#b2df8a',
        culture: '#fccde5'
    };

    const map = L.map('map').setView([40.4168, -3.7038], 14);

    // Dark theme from CartoDB
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CartoDB',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    const data = {
        general: [
            {
                name: "פוארטה דל סול",
                desc: "כיכר מרכזית וסמל העיר מדריד.",
                coords: [40.4168, -3.7038],
                hours: "24/7"
            },
            {
                name: "פסל הדוב ועץ התות",
                desc: "הסמל הרשמי של מדריד.",
                coords: [40.4169, -3.7037],
                hours: "פתוח תמיד"
            },
            {
                name: "פלאסה מאיור",
                desc: "כיכר היסטורית עם בתי קפה וארכיטקטורה מדהימה.",
                coords: [40.4154, -3.7074],
                hours: "פתוח תמיד"
            },
            {
                name: "הארמון המלכותי",
                desc: "הארמון המלכותי של מדריד.",
                coords: [40.4179, -3.7143],
                hours: "10:00–18:00"
            },
            {
                name: "קתדרלת אלמודנה",
                desc: "קתדרלה מרשימה בסמוך לארמון המלכותי.",
                coords: [40.4153, -3.7143],
                hours: "10:00–20:00
            }
        ],
        markets: [
            {
                name: "Mercado de San Miguel",
                desc: "שוק טאפאס מודרני ומעוצב.",
                coords: [40.4152, -3.7094],
                hours: "10:00–24:00"
            }
        ],
        museums: [
            {
                name: "Museo del Prado",
                desc: "אחד ממוזיאוני האמנות החשובים בעולם.",
                coords: [40.4138, -3.6921],
                hours: "10:00–20:00"
            }
        ],
        parks: [
            {
                name: "פארק רטירו",
                desc: "פארק עם אגם וארמון זכוכית.",
                coords: [40.4153, -3.6845],
                hours: "06:00–22:00"
            }
        ],
        culture: [
            {
                name: "תיאטרון ריאל",
                desc: "בית האופרה הראשי של מדריד.",
                coords: [40.4180, -3.7100],
                hours: "לפי הופעות"
            }
        ]
    };

    navigator.geolocation.getCurrentPosition(pos => {
        const userLat = pos.coords.latitude;
        const userLng = pos.coords.longitude;

        Object.entries(data).forEach(([category, points]) => {
            points.forEach((point, idx) => {
                const destination = `${point.coords[0]},${point.coords[1]}`;
                const appleMapsUrl = `https://maps.apple.com/?saddr=${userLat},${userLng}&daddr=${destination}`;

                const popupHTML = `
                    <strong>${point.name}</strong><br>
                    ${point.desc}<br>
                    🕒 ${point.hours}<br>
                    📍 <a href="${appleMapsUrl}" target="_blank">התחל ניווט</a>
                `;

                const icon = L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30],
                    popupAnchor: [0, -30]
                });

                L.marker(point.coords, { icon })
                    .addTo(map)
                    .bindPopup(popupHTML)
                    .on('mouseover', function () { this.openPopup(); });
            });
        });
    }, () => alert("לא הצלחנו לאתר את מיקומך."));

    // Toggle legend
    function toggleLegend() {
        const legend = document.getElementById("legend");
        legend.style.display = (legend.style.display === "none" || legend.style.display === "") ? "block" : "none";
    }

    // כפתור 'מצא אותי'
    const locateButton = L.control({position: 'topleft'});
    locateButton.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const button = L.DomUtil.create('a', '', div);
        button.innerHTML = '📍';
        button.href = '#';
        button.title = 'הראה את מיקומי הנוכחי';

        L.DomEvent.on(button, 'click', function(e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            map.locate({setView: true, maxZoom: 16});
        });

        return div;
    };
    locateButton.addTo(map);

    map.on('locationfound', function(e) {
        L.circle(e.latlng, {
            radius: 30,
            color: '#80c9ff',
            fillColor: '#80c9ff',
            fillOpacity: 0.5
        }).addTo(map).bindPopup("אתה כאן").openPopup();
    });

    map.on('locationerror', function(e) {
        alert("לא ניתן היה למצוא את מיקומך.");
    });
</script>
</body>
</html>
